<% page='usuarios' %>

    <div class="row">
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person me-2"></i>
                    <%= usuario.id ? 'Editar Usuário' : 'Novo Usuário' %>
                </div>
                <div class="card-body">
                    <form id="formUsuario">
                        <input type="hidden" id="usuarioId" value="<%= usuario.id || '' %>">

                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nome" value="<%= usuario.nome || '' %>"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" value="<%= usuario.username || '' %>"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">
                                Senha <%= usuario.id ? '(deixe em branco para manter a atual)' : '*' %>
                            </label>
                            <input type="password" class="form-control" id="password" <%=!usuario.id ? 'required' : ''
                                %>>
                        </div>

                        <div class="mb-3">
                            <label for="empresaId" class="form-label">Empresa *</label>
                            <select class="form-select" id="empresaId" required>
                                <option value="">Selecione uma empresa</option>
                                <% empresas.forEach(function(empresa) { %>
                                    <option value="<%= empresa.id %>" <%=usuario.empresaId==empresa.id ? 'selected' : ''
                                        %>>
                                        <%= empresa.nome %>
                                    </option>
                                    <% }); %>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role">
                                <option value="admin" <%=usuario.role==='admin' ? 'selected' : '' %>>Admin</option>
                                <option value="operador" <%=usuario.role==='operador' ? 'selected' : '' %>>Operador
                                </option>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isSuperAdmin" <%=usuario.isSuperAdmin
                                ? 'checked' : '' %>>
                            <label class="form-check-label" for="isSuperAdmin">
                                <i class="bi bi-shield-check text-danger me-2"></i>
                                Super Administrador (acesso ao painel admin)
                            </label>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-admin-primary">
                                <i class="bi bi-check-circle me-2"></i>Salvar
                            </button>
                            <a href="/admin/usuarios" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('formUsuario').addEventListener('submit', async function (e) {
            e.preventDefault();

            const usuarioId = document.getElementById('usuarioId').value;
            const isEdit = !!usuarioId;

            const data = {
                nome: document.getElementById('nome').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                empresaId: document.getElementById('empresaId').value,
                role: document.getElementById('role').value,
                isSuperAdmin: document.getElementById('isSuperAdmin').checked
            };

            try {
                const url = isEdit ? `/admin/usuarios/${usuarioId}` : '/admin/usuarios';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.href = '/admin/usuarios';
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar usuário.');
            }
        });
    </script>
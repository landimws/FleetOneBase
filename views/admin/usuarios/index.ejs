<% page='usuarios' %>

    <!-- Script Definido no Topo para Garantir Disponibilidade -->
    <script>
        console.log('üèÅ [F1Admin] Inicializando namespace global...');

        window.F1Admin = {
            novoUsuario: function () {
                console.log('üöÄ Novo Usu√°rio Clicado');
                window.location.href = '/admin/usuarios/novo';
            },

            editarUsuario: function (id) {
                console.log('‚úèÔ∏è Editar Usu√°rio ID:', id);
                window.location.href = `/admin/usuarios/novo?id=${id}`;
            },

            filtrarPorEmpresa: function (selectElement) {
                const empresaId = selectElement.value;
                console.log('üîç Filtro alterado:', empresaId);
                const url = empresaId ? `/admin/usuarios?empresaId=${empresaId}` : '/admin/usuarios';
                window.location.href = url;
            },

            toggleStatus: async function (id, ativo, btnElement) {
                console.log('üîÑ Toggle Status ID:', id, ativo);
                const acao = ativo ? 'desativar' : 'ativar';

                if (!confirm(`Tem certeza que deseja ${acao} este usu√°rio?`)) return;

                // Feedback visual b√°sico
                if (btnElement) btnElement.disabled = true;

                try {
                    const response = await fetch(`/admin/usuarios/${id}/toggle-status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Alert nativo para garantir que o usu√°rio veja
                        alert(data.message || 'Status alterado com sucesso!');
                        window.location.reload();
                    } else {
                        alert('Erro: ' + (data.message || 'Desconhecido'));
                        if (btnElement) btnElement.disabled = false;
                    }
                } catch (e) {
                    console.error('Erro no toggle:', e);
                    alert('Erro de conex√£o ou servidor.');
                    if (btnElement) btnElement.disabled = false;
                }
            }
        };

        console.log('‚úÖ [F1Admin] Fun√ß√µes carregadas no window.F1Admin');
    </script>

    <div class="row mb-4">
        <div class="col-md-8">
            <button class="btn btn-admin-primary" onclick="window.F1Admin.novoUsuario()">
                <i class="bi bi-plus-circle me-2"></i>Novo Usu√°rio
            </button>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="filtroEmpresa" onchange="window.F1Admin.filtrarPorEmpresa(this)">
                <option value="">Todas as Empresas</option>
                <% empresas.forEach(function(empresa) { %>
                    <option value="<%= empresa.id %>" <%=filtroEmpresaId==empresa.id ? 'selected' : '' %>>
                        <%= empresa.nome %>
                    </option>
                    <% }); %>
            </select>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="bi bi-people me-2"></i>Lista de Usu√°rios
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Username</th>
                            <th>Empresa</th>
                            <th>Role</th>
                            <th>SuperAdmin</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (usuarios && usuarios.length> 0) { %>
                            <% usuarios.forEach(function(usuario) { %>
                                <tr>
                                    <td>
                                        <%= usuario.id %>
                                    </td>
                                    <td><strong>
                                            <%= usuario.nome %>
                                        </strong></td>
                                    <td><code><%= usuario.username %></code></td>
                                    <td>
                                        <% if (usuario.Empresa) { %>
                                            <%= usuario.Empresa.nome %>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                    <% } %>
                                    </td>
                                    <td><span class="badge bg-info">
                                            <%= usuario.role %>
                                        </span></td>
                                    <td>
                                        <% if (usuario.isSuperAdmin) { %>
                                            <i class="bi bi-shield-check text-danger" title="Super Administrador"></i>
                                            <% } else { %>
                                                -
                                                <% } %>
                                    </td>
                                    <td>
                                        <span class="badge <%= usuario.ativo ? 'badge-ativo' : 'badge-inativo' %>">
                                            <%= usuario.ativo ? 'Ativo' : 'Inativo' %>
                                        </span>
                                    </td>
                                    <td>
                                        <!-- Aspas garantem que ID seja tratado como string ou valor seguro -->
                                        <button class="btn btn-sm btn-outline-primary"
                                            onclick="window.F1Admin.editarUsuario('<%= usuario.id %>')">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button
                                            class="btn btn-sm btn-outline-<%= usuario.ativo ? 'danger' : 'success' %>"
                                            onclick="window.F1Admin.toggleStatus('<%= usuario.id %>', <%= usuario.ativo %>, this)">
                                            <i class="bi bi-<%= usuario.ativo ? 'x-circle' : 'check-circle' %>"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                Nenhum usu√°rio encontrado.
                                            </td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
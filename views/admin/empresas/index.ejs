<% page='empresas' %>

    <div class="row mb-4">
        <div class="col-12 col-md-8">
            <a href="/admin/empresas/novo" class="btn btn-admin-primary">
                <i class="bi bi-plus-circle me-2"></i>Nova Empresa
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="bi bi-building me-2"></i>Lista de Empresas
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>CNPJ</th>
                            <th>Usu√°rios</th>
                            <th>Status</th>
                            <th>Credenciais</th>
                            <th>Criado em</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (empresas && empresas.length> 0) { %>
                            <% empresas.forEach(function(empresa) { %>
                                <tr>
                                    <td>
                                        <%= empresa.id %>
                                    </td>
                                    <td><strong>
                                            <%= empresa.nome %>
                                        </strong></td>
                                    <td>
                                        <%= empresa.cnpj || '-' %>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            <%= empresa.numUsuarios %> usu√°rio<%= empresa.numUsuarios !==1 ? 's' : '' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge <%= empresa.ativo ? 'badge-ativo' : 'badge-inativo' %>">
                                            <%= empresa.ativo ? 'Ativo' : 'Inativo' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <% if (empresa.usuarioPendente) { %>
                                                <button class="btn btn-sm btn-warning"
                                                    onclick="mostrarCredenciais('<%= empresa.usuarioPendente.username %>', '<%= empresa.usuarioPendente.senha_temporaria_visivel %>', '<%= empresa.id %>')"
                                                    title="Ver credenciais tempor√°rias">
                                                    <i class="bi bi-key-fill"></i>
                                                </button>
                                                <% } %>

                                                    <!-- Bot√£o Impersonate -->
                                                    <!-- Bot√£o Impersonate (Modal) -->
                                                    <button type="button" class="btn btn-sm btn-dark"
                                                        onclick="confirmImpersonate('<%= empresa.id %>', '<%= empresa.nome %>')"
                                                        title="Acessar Painel (Impersonate)">
                                                        <i class="bi bi-incognito"></i>
                                                    </button>
                                        </div>
                                    </td>
                                    <td>
                                        <%= new Date(empresa.createdAt).toLocaleDateString('pt-BR') %>
                                    </td>
                                    <td>
                                        <a href="/admin/empresas/novo?id=<%= empresa.id %>"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button
                                            class="btn btn-sm btn-outline-<%= empresa.ativo ? 'danger' : 'success' %>"
                                            data-id="<%= empresa.id %>"
                                            data-ativo="<%= empresa.ativo ? 'true' : 'false' %>"
                                            onclick="toggleStatus(this)">
                                            <i class="bi bi-<%= empresa.ativo ? 'x-circle' : 'check-circle' %>"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                Nenhuma empresa cadastrada.
                                            </td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Credenciais Tempor√°rias -->
    <div class="modal fade" id="modalCredenciais" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-key-fill me-2"></i>Credenciais Tempor√°rias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Estas credenciais s√£o tempor√°rias e ser√£o removidas ap√≥s o primeiro
                        login.
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Empresa ID:</label>
                        <input type="text" class="form-control" id="modalEmpresaId" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Usu√°rio:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="modalUsername" readonly>
                            <button class="btn btn-outline-secondary" onclick="copiar('modalUsername')"
                                title="Copiar usu√°rio">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Senha Tempor√°ria:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="modalSenha" readonly>
                            <button class="btn btn-outline-secondary" onclick="copiar('modalSenha')"
                                title="Copiar senha">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>üìå Instru√ß√µes:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Envie estas credenciais para o respons√°vel da empresa</li>
                            <li>No primeiro login, o sistema for√ßar√° a troca de senha</li>
                            <li>Ap√≥s a troca, estas credenciais n√£o estar√£o mais dispon√≠veis aqui</li>
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Impersonate -->
    <div class="modal fade" id="modalImpersonate" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-mask me-2"></i>Acesso de Suporte (Impersonate)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 text-warning-emphasis">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Voc√™ est√° prestes a acessar o painel da empresa:
                        <div class="h5 mt-2 mb-0" id="impersonateEmpresaNome"></div>
                    </div>

                    <p class="mb-2">Ao confirmar, voc√™ ser√° redirecionado para o ambiente do cliente com
                        <strong>permiss√µes administrativas</strong>.</p>

                    <ul class="text-muted small mb-4">
                        <li>Todas as a√ß√µes realizadas ser√£o registradas em auditoria.</li>
                        <li>Seu acesso de Super Admin ficar√° suspenso temporariamente.</li>
                        <li>Para retornar, utilize o bot√£o <strong>"Sair do Suporte"</strong> no topo da tela.</li>
                    </ul>

                    <div class="d-grid">
                        <form id="formImpersonate" action="" method="POST">
                            <button type="submit" class="btn btn-danger w-100 fw-bold">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Confirmar e Acessar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmImpersonate(empresaId, empresaNome) {
            document.getElementById('impersonateEmpresaNome').textContent = empresaNome;
            document.getElementById('formImpersonate').action = `/admin/empresas/${empresaId}/impersonate`;

            const modal = new bootstrap.Modal(document.getElementById('modalImpersonate'));
            modal.show();
        }



        async function toggleStatus(btnElement) {
            const id = btnElement.dataset.id;
            const ativoAtual = btnElement.dataset.ativo === 'true';
            const acao = ativoAtual ? 'desativar' : 'ativar';

            if (!confirm(`Tem certeza que deseja ${acao} esta empresa?${ativoAtual ? '\n\nATEN√á√ÉO: Todos os usu√°rios desta empresa ser√£o desativados automaticamente!' : ''}`)) {
                return;
            }

            // Ativar loading no bot√£o clicado
            Loading.show(btnElement);

            try {
                const response = await fetch(`/admin/empresas/${id}/toggle-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    Toast.show(data.message, 'success');
                    // Pequeno delay para usu√°rio ver o toast antes do reload
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    Toast.show('Erro: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                Toast.show('Erro ao alterar status da empresa.', 'error');
            } finally {
                Loading.hide(btnElement);
            }
        }

        // Fun√ß√£o para exibir modal com credenciais
        function mostrarCredenciais(username, senha, empresaId) {
            document.getElementById('modalEmpresaId').value = empresaId;
            document.getElementById('modalUsername').value = username;
            document.getElementById('modalSenha').value = senha;

            const modal = new bootstrap.Modal(document.getElementById('modalCredenciais'));
            modal.show();
        }

        // Fun√ß√£o para copiar para clipboard
        function copiar(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // Mobile

            navigator.clipboard.writeText(element.value).then(() => {
                Toast.show('Copiado para √°rea de transfer√™ncia!', 'success');
            }).catch(err => {
                // Fallback para navegadores antigos
                document.execCommand('copy');
                Toast.show('Copiado!', 'success');
            });
        }
    </script>